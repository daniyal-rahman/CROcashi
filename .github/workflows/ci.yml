name: ci

on:
  push: { branches: ["main"] }
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ncfd
          POSTGRES_PASSWORD: ncfd
          POSTGRES_DB: ncfd
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U ncfd" --health-interval=5s
          --health-timeout=5s --health-retries=10
      minio:
        image: minio/minio:latest
        ports: ["9000:9000","9001:9001"]
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        options: --health-cmd="curl -f http://localhost:9000/minio/health/ready || exit 1" --health-interval=5s --health-retries=10
        command: server /data --console-address ":9001"

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: ${{ matrix.python-version }} }

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}

      - name: Install
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -U pip
          pip install -e .[dev]
      - name: Env file
        run: |
          cat > .env <<'EOF'
          CONFIG_PROFILE=local
          POSTGRES_DSN=postgresql+psycopg2://ncfd:ncfd@localhost:5432/ncfd
          DUCKDB_PATH=./data/duckdb/ci.duckdb
          S3_ENDPOINT_URL=http://localhost:9000
          S3_REGION=us-east-1
          S3_BUCKET=ncfd-raw
          S3_ACCESS_KEY=minioadmin
          S3_SECRET_KEY=minioadmin
          S3_USE_SSL=false
          UNPAYWALL_EMAIL=ci@example.com
          OPENALEX_EMAIL=ci@example.com
          SEC_USER_AGENT=ncfd-ci ci@example.com
          EOF
      - name: DB migrate
        run: |
          . .venv/bin/activate
          alembic upgrade head
      - name: Lint + Type + Test
        run: |
          . .venv/bin/activate
          ruff check .
          black --check .
          mypy src
          pytest -q
